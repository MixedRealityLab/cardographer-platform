# Cardographer data model

## Card authoring

A card deck is the unit of authoring.
There is a `CardDeckSummary` for each deck, with:
- `_id` (string/MongoDB ObjectID) - unique
- `name` (string) - denorm from latest revision (below)
- `description` (string) - denorm from latest revision
- `credits` (string) - denorm from latest revision
- `isPublic` (boolean)
- `owners` (string[]) - emails (or similar unique IDs of owners of the deck for RBAC)
- `currentRevision` (number) - from CardDeckRevision.revision

### Card Deck Revision

A card deck may go through several revisions.
A revision is basic unit of card deck use.
There is a `CardDeckRevision` for each revision, with:
- `_id` (string) - unique (card deck id plus revision number)
- `deckId` (string) - deck id
- `revision` (number) - auto-increment integer, starting at 1
- `slug` (string, optional) - file/URL component for revision
- `deckName` (string) - deck name
- `deckDescription` (string)
- `deckCredits` (string)
- `created` (ISO date string/MongoDB Date)
- `lastModified` (ISO date string/MongoDB Date)
- `revisionName` (string) - revision name (addition to deckName)
- `revisionDescription` (string) - specifically about the description
- `isUsable` (boolean) - can be used from card tools (or not ready)
- `isPublic` (boolean) - publicly listed
- `isLocked` (boolean) - not editable (can be unlocked)
- `isTemplate` (boolean) - can be used as template for new deck
- `cardCount` (number) - for summary
- `propertyDefs` (CardPropertyDef[]) - card metadata definitions (see below)
- `defaults` (CardInfo) - default metadata for all cards in this revision
- `cards` (CardInfo[]) - metadata for each card in this revision
- `back` (CardInfo) - metadata for card back (generation)
- `build` (DeckBuild) - configuration/assets for deck generation (see below)
- `output` (DeckOutput) - final/usable deck images

Not part of the database, but the API may return the following:
- `isCurrent` (boolean) - from CardDeckSummary.currentRevision == revision

### Card Info / Card Properties

Each metadata field on a card is defined by a `CardPropertyDef`, with:
- `use` (string) - standard use, see below, default to value of `fieldname` if not specified
- `customFieldname` (string, optional) - programming-style name, used as field name, defaults to value of `use` (if not specified) and generally only needed if multiple subtypes, attributes etc are required.
- `title` (string) - spreadsheet column title
- `description` (string)
- `defaultExport` (boolean) - include in default export
- `sortBy` (number) - to sort e.g. columns

`CardInfo`, has fields to match `use` values (below), plus:
- `custom` - custom fields and values (object)

Standard card properties (`use` options and `CardInfo` fields) 
include *standard metadata*:
- `id` - card ID (of some sort - doesn't change with revisions)
- `revision` - card revision number
- `link` - more info url
- `name` - card name
- `description` - card description
- `slug` - card filename part
- `credits`
- `created` (string/ISO/Date)
- `lastModified` (string/ISO/Date)

*Basic card properties*:
- `width` - nominal physical width, mm
- `height` - nominal physical height, mm
- `sizeName` - e.g. "poker", "bridge", "tarot", [e.g.](https://www.makeplayingcards.com/printed-card-types.aspx)

*Deck-specific card properties*:
- `sortBy` - number to sort by, ascending
- `category` - e.g. like a suit
- `subtype` - e.g. sub-category
- `attribute` - card-specific attribute of some kind, e.g. rank

*Card generation information*:
- `assetFile` - file (esp. image) used to create the card
- `content` - card-specific text of some kind

*Card output*, i.e. generated card metadata:
- `frontUrl` - full URL of front image
- `backUrl` - full URL of back image
- `frontFile` - filename (only) of front image
- `frontTop`, `frontLeft`, `frontWidth`, `frontHeight` - front image size & offset (optional)
- `backFile` - filename (only) of back image
- `backTop`, `backLeft`, `backWidth`, `backHeight` - back image size & offset (optional)

### Deck Build

Sometimes (but not always) the platform will help to generate 
the cards (draft or final versions).
Information specific to this is help in `DeckBuild`, which has:
- `files`? - a set of asset files used in the build
- `builderId` (string) - identifies specific build plugin to use
- `builderName` (string) - human readable
- `config` (object?) - plugin-specific build configuration
- `lastBuilt` (string/Date)
- `status` (string), "unbuilt", "building", "failed", "built"
- `messages` (string[]) - from last build
- `isDisabled` (boolean) - e.g. after switching to final manual creation.

(to be refined - may need extra CardInfo here generated by the build)

If/when builders can be set/changed,
there will need to be info about build plugins
- `id` - match `DeckBuild.builder`
- `name` - human readable
- ...

Each builder will need an interface, at least
`build`: {revision:`CardDeckRevision`, config:`BuilderConfig`+?} -> {
- `messages` (string[])
- `error` (string) - empty if OK 
- `cards` (CardInfo[]) - extra information for the cards

`BuilderConfig` will need at least:
- `filePath` (string) - uploads file path
- `baseUrl` (string) - public URL base for serving generated files

### Deck Output

Resources required for the deck to be used, mainly final front and back
images.
These may be provided by the user or generated by an automated build.
`DeckOutput`, object with:
- `files` - a set of final image files (per card or atlas(es))
- `isUserModified` (boolean) - if changed directly by the user

(to be refined)

## Design notes

Note, I'm thinking of prototype + cloning model rather than 
regular CRUD. I.e. the only way to make a new Deck would be to clone
an existing CardDeckRevision with isTemplate set, and each new
revision would be clone of the previous revision. The process would
be bootstrapped with a manually added master template or two.

## Sessions

To do

